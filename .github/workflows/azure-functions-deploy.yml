name: Deploy UI to Azure Functions

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_NAME: oan-ui-function
  ACR_NAME: oanregistry1407
  IMAGE_NAME: oan-seeker-ui-functions
  # Backend API URLs
  VITE_WEATHER_API_URL: "https://oan-mock-function.azurewebsites.net/api/v1/weather/WeatherUI"
  VITE_SEARCH_API_URL: "https://oan-mock-function.azurewebsites.net/api/v1/schemes/"
  VITE_STATES_API_URL: "https://oan-mock-function.azurewebsites.net/api/v1/states/"
  VITE_DISTRICTS_API_URL: "https://oan-mock-function.azurewebsites.net/api/v1/districts"
  VITE_AIBOT_API_URL: "https://oan-ai-function.azurewebsites.net/api/chat/"
  VITE_TRANSCRIBE_API_URL: "https://oan-ai-function.azurewebsites.net/api/transcribe/"
  VITE_TTS_API_URL: "https://oan-ai-function.azurewebsites.net/api/tts/"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name:  Checkout Code
        uses: actions/checkout@v4

      - name:  Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name:  Login to Azure Container Registry
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name:  Build and Push Docker Image
        run: |
          docker build \
            -f Dockerfile.functions \
            -t ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest \
            --build-arg VITE_WEATHER_API_URL="${{ env.VITE_WEATHER_API_URL }}" \
            --build-arg VITE_AIBOT_API_URL="${{ env.VITE_AIBOT_API_URL }}" \
            --build-arg VITE_SEARCH_API_URL="${{ env.VITE_SEARCH_API_URL }}" \
            --build-arg VITE_TRANSCRIBE_API_URL="${{ env.VITE_TRANSCRIBE_API_URL }}" \
            --build-arg VITE_TTS_API_URL="${{ env.VITE_TTS_API_URL }}" \
            --build-arg VITE_STATES_API_URL="${{ env.VITE_STATES_API_URL }}" \
            --build-arg VITE_DISTRICTS_API_URL="${{ env.VITE_DISTRICTS_API_URL }}" \
            .
          
          docker push ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest

      - name:  Deploy to Azure Function App
        uses: Azure/functions-container-action@v1
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          image: ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest

      - name:  Deployment Complete
        run: |
          echo " Deployment successful!"
          echo " Your app is available at: https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net"
